<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Book Appointment | VetCare Veterinary Center</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <!-- Flatpickr CSS -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    /* Enhanced Navbar Styles */
    .navbar {
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      background: rgba(255, 255, 255, 0.95) !important;
    }
    
    .navbar.scrolled {
      background: rgba(255, 255, 255, 0.98) !important;
      box-shadow: 0 2px 20px rgba(0,0,0,0.1) !important;
    }
    
    .brand-logo {
      font-size: 2rem;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover .brand-logo {
      transform: scale(1.1);
    }
    
    .brand-text {
      font-size: 1.5rem;
      letter-spacing: -0.5px;
    }
    
    .nav-link {
      position: relative;
      transition: all 0.3s ease;
      padding: 0.75rem 1rem !important;
      border-radius: 8px;
      margin: 0 0.25rem;
    }
    
    .nav-link:hover {
      background: rgba(247, 200, 115, 0.1);
      color: #f7c873 !important;
      transform: translateY(-2px);
    }
    
    .nav-link.active {
      background: rgba(247, 200, 115, 0.15);
      color: #f7c873 !important;
      font-weight: 600 !important;
    }
    
    .dropdown-menu {
      border-radius: 12px;
      padding: 0.5rem 0;
      margin-top: 0.5rem;
      opacity: 0;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      display: none;
    }
    
    .dropdown-item {
      padding: 0.75rem 1.5rem;
      transition: all 0.3s ease;
      border-radius: 8px;
      margin: 0 0.5rem;
    }
    
    .dropdown-item:hover {
      background: rgba(247, 200, 115, 0.1);
      color: #f7c873;
      transform: translateX(5px);
    }
    
    .btn-warning {
      background: linear-gradient(135deg, #f7c873, #f39c12);
      border: none;
      transition: all 0.3s ease;
    }
    
    .btn-warning:hover {
      background: linear-gradient(135deg, #f39c12, #e67e22);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(247, 200, 115, 0.4) !important;
    }
    
    .navbar-toggler:focus {
      box-shadow: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 991.98px) {
      .navbar-nav {
        padding: 1rem 0;
      }
      
      .nav-link {
        padding: 0.75rem 0 !important;
        margin: 0.25rem 0;
      }
      
      .btn-warning {
        margin-top: 1rem;
        width: 100%;
      }
    }
    
    /* Original styles */
    .hero-img {
      width: 100%;
      max-width: 500px;
      border: 3px solid #f7c873;
      border-radius: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .bg-dark-blue {
      background: #0d1b3f;
    }
    .announcement-bar {
      background: #3498db;
      color: #fff;
      padding: 0.5rem 0;
      font-size: 1rem;
    }
    .booking-form {
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.1);
      padding: 2rem;
      margin-top: 2rem;
    }
    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      font-size: 1rem;
      transition: border-color 0.2s;
    }
    .form-control:focus, .form-select:focus {
      border-color: #f7c873;
      box-shadow: 0 0 0 0.2rem rgba(247, 200, 115, 0.25);
    }
    .custom-image-label {
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      margin-bottom: 6px;
      font-weight: 500;
      color: #27ae60;
      font-size: 1.08em;
      user-select: none;
    }
    .custom-image-btn {
      background: #232b3b;
      color: #fff;
      border-radius: 8px;
      padding: 8px 18px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-size: 1em;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: background 0.18s, color 0.18s;
    }
    .custom-image-btn:hover {
      background: #27ae60;
      color: #fff;
    }
    .image-filename {
      color: #6c757d;
      font-size: 0.98em;
      font-style: italic;
      margin-left: 4px;
    }
    .image-preview {
      margin-top: 4px;
      margin-bottom: 10px;
    }
    .success-message {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
    }
    .error-message {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 15px;
      padding: 2rem;
      text-align: center;
    }
    
    /* Availability indicator styles */
    .availability-indicator {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
    }
    
    .availability-high {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.2);
    }
    
    .availability-medium {
      background: rgba(255, 193, 7, 0.1);
      color: #ffc107;
      border: 1px solid rgba(255, 193, 7, 0.2);
    }
    
    .availability-low {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.2);
    }
    
    /* Flatpickr customization for better availability display */
    .flatpickr-calendar {
      box-shadow: 0 10px 30px rgba(0,0,0,0.15) !important;
    }
    
    .flatpickr-time input.flatpickr-hour:disabled,
    .flatpickr-time input.flatpickr-minute:disabled {
      background: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }
    .loading-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      display: flex;
      justify-content: center;
      align-items: center;
      border-radius: 15px;
      z-index: 1000;
      backdrop-filter: blur(2px);
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #f7c873;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .booking-form {
      position: relative;
    }
  </style>
</head>
<body>
  <!-- Enhanced Navbar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm sticky-top">
    <div class="container">
      <!-- Logo/Brand -->
      <a class="navbar-brand fw-bold d-flex align-items-center" href="index.html">
        <div class="brand-logo me-2">
          <i class="bi bi-heart-pulse-fill text-danger"></i>
        </div>
        <span class="brand-text">
          <span class="text-primary">Vet</span><span class="text-warning">Care</span>
        </span>
      </a>

      <!-- Mobile Toggle Button -->
      <button class="navbar-toggler border-0" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>

      <!-- Navigation Menu -->
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item">
            <a class="nav-link fw-semibold" href="index.html">
              <i class="bi bi-house-door me-1"></i>Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-semibold" href="about.html">
              <i class="bi bi-info-circle me-1"></i>About Us
            </a>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle fw-semibold" href="#" id="servicesDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-gear me-1"></i>Services
            </a>
            <ul class="dropdown-menu dropdown-menu-end shadow border-0" aria-labelledby="servicesDropdown">
              <li><a class="dropdown-item" href="services.html"><i class="bi bi-clipboard2-pulse me-2"></i>Veterinary Services</a></li>
              <li><a class="dropdown-item" href="emergency.html"><i class="bi bi-exclamation-triangle me-2"></i>Emergency Care</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="pharmacy.html"><i class="bi bi-capsule me-2"></i>Online Pharmacy</a></li>
            </ul>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-semibold" href="client-center.html">
              <i class="bi bi-person-circle me-1"></i>Client Center
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-semibold" href="#">
              <i class="bi bi-people me-1"></i>Join Our Team
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link fw-semibold" href="contact.html">
              <i class="bi bi-envelope me-1"></i>Contact
            </a>
          </li>
          <li class="nav-item ms-lg-3">
            <a class="btn btn-warning fw-bold px-4 py-2 rounded-pill shadow-sm active" href="booking.html">
              <i class="bi bi-calendar-check me-2"></i>Book Appointment
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Announcement Bar -->
  <div class="announcement-bar text-center">
    <span class="me-2"><i class="bi bi-info-circle"></i></span>
    New clients welcome! Limited time free first exam (<a href="#" class="text-white text-decoration-underline">terms apply</a>) – <a href="#" class="text-white fw-bold text-decoration-underline">Book Now!</a>
  </div>

  <!-- Booking Form Section -->
  <section class="py-5" style="background: #f5f6fa;">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-lg-7 mb-4 mb-lg-0">
          <div class="booking-form">
            <h2 class="fw-bold mb-4">Book Your Appointment</h2>
            <p class="mb-4">Schedule a visit for your beloved pet with our experienced veterinary team. We're here to provide the best care possible for your furry family member.</p>
            <div class="d-flex align-items-center mb-4">
              <i class="bi bi-clock text-warning me-2" style="font-size: 1.5rem;"></i>
              <span class="text-muted">Appointments available within 24-48 hours</span>
            </div>
            
            <!-- Calendar Availability Display -->
            <div id="calendar-info" class="mb-4"></div>
            
            <form id="bookingForm">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <input type="text" class="form-control" name="first_name" placeholder="First Name" required>
                </div>
                <div class="col-md-6 mb-3">
                  <input type="text" class="form-control" name="last_name" placeholder="Last Name" required>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <input type="email" class="form-control" name="email" placeholder="Email" required>
                </div>
                <div class="col-md-6 mb-3">
                  <input type="tel" class="form-control" name="phone_number" placeholder="Phone Number" required>
                </div>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="pet-type" class="form-label fw-bold">Pet Type</label>
                  <select class="form-select" name="pet_type" required>
                    <option value="">Select Pet Type</option>
                    <option value="dog">Dog</option>
                    <option value="cat">Cat</option>
                    <option value="bird">Bird</option>
                    <option value="reptile">Reptile</option>
                  </select>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="service" class="form-label fw-bold">Service Required</label>
                  <select class="form-select" name="service_type" required>
                    <option value="" disabled selected>Select Service Type</option>
                    <option value="Vaccination">Vaccination</option>
                    <option value="Physiotherapy">Physiotherapy</option>
                    <option value="Dermatology">Dermatology</option>
                    <option value="Operation">Operation</option>
                    <option value="General Checkup">General Checkup</option>
                    <option value="Dental Care">Dental Care</option>
                  </select>
                </div>
              </div>
              <div class="mb-3">
                <label for="image" class="custom-image-label">
                  <span class="custom-image-btn"><i class="bi bi-upload"></i> Upload Pet Image</span>
                  <span id="image-filename" class="image-filename">No file chosen</span>
                </label>
                <input type="file" name="image" id="image" accept="image/*" required style="display:none;">
                <div id="image-preview" class="image-preview" style="display:none;"></div>
              </div>
              <div class="mb-3">
                <input type="text" class="form-control" name="reason" placeholder="Reason for Visit" required>
              </div>
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label for="datePicker" class="form-label fw-bold">Choose Date</label>
                  <input type="text" class="form-control" id="datePicker" name="selected_date" placeholder="Select a date" required>
                  <div id="availability-info" class="mt-2"></div>
                  <small class="text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Select a date to see available time slots.
                  </small>
                </div>
                <div class="col-md-6 mb-3">
                  <label for="timePicker" class="form-label fw-bold">Choose Time</label>
                  <select class="form-select" id="timePicker" name="selected_time" required disabled>
                    <option value="">Select a date first</option>
                  </select>
                  <small class="text-muted">
                    <i class="bi bi-clock me-1"></i>
                    Available times will appear after selecting a date.
                  </small>
                </div>
              </div>
              <div class="text-center">
                <button type="submit" class="btn btn-warning fw-bold px-5 py-3">
                  <i class="bi bi-calendar-check me-2"></i>Book Appointment
                </button>
              </div>
            </form>
          </div>
        </div>
        <div class="col-lg-5 text-center">
          <img src="images/grey-fluffy-domestic-cat-with-long-hair-showing-its-affection-brown-dog-with-long-hair.jpg" alt="Pet Care" class="hero-img img-fluid">
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-dark text-white py-5">
    <div class="container">
      <div class="row g-4">
        <!-- Contact Information -->
        <div class="col-lg-4 col-md-6">
          <h5 class="fw-bold mb-4 text-warning">
            <i class="bi bi-heart-pulse-fill me-2"></i>VetCare Veterinary Center
          </h5>
          <div class="mb-3">
            <i class="bi bi-geo-alt text-warning me-2"></i>
            <span>123 Veterinary Drive<br>Upper Vetcare, MD 21201</span>
          </div>
          <div class="mb-3">
            <i class="bi bi-telephone text-warning me-2"></i>
            <span>Main: (410) 555-0123</span>
          </div>
          <div class="mb-3">
            <i class="bi bi-exclamation-triangle text-warning me-2"></i>
            <span>Emergency: (410) 555-9999</span>
          </div>
          <div class="mb-3">
            <i class="bi bi-envelope text-warning me-2"></i>
            <span>info@vetcare.com</span>
          </div>
        </div>

        <!-- Quick Links -->
        <div class="col-lg-2 col-md-6">
          <h6 class="fw-bold mb-4 text-warning">Quick Links</h6>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="index.html" class="text-white text-decoration-none">Home</a></li>
            <li class="mb-2"><a href="about.html" class="text-white text-decoration-none">About Us</a></li>
            <li class="mb-2"><a href="services.html" class="text-white text-decoration-none">Services</a></li>
            <li class="mb-2"><a href="emergency.html" class="text-white text-decoration-none">Emergency Care</a></li>
            <li class="mb-2"><a href="contact.html" class="text-white text-decoration-none">Contact</a></li>
          </ul>
        </div>

        <!-- Services -->
        <div class="col-lg-2 col-md-6">
          <h6 class="fw-bold mb-4 text-warning">Services</h6>
          <ul class="list-unstyled">
            <li class="mb-2"><a href="services.html" class="text-white text-decoration-none">Veterinary Care</a></li>
            <li class="mb-2"><a href="emergency.html" class="text-white text-decoration-none">Emergency Care</a></li>
            <li class="mb-2"><a href="pharmacy.html" class="text-white text-decoration-none">Pharmacy</a></li>
            <li class="mb-2"><a href="booking.html" class="text-white text-decoration-none">Book Appointment</a></li>
            <li class="mb-2"><a href="client-center.html" class="text-white text-decoration-none">Client Center</a></li>
          </ul>
        </div>

        <!-- Office Hours -->
        <div class="col-lg-4 col-md-6">
          <h6 class="fw-bold mb-4 text-warning">Office Hours</h6>
          <div class="row">
            <div class="col-6">
              <p class="mb-1"><strong>Monday - Friday:</strong></p>
              <p class="mb-1"><strong>Saturday:</strong></p>
              <p class="mb-1"><strong>Sunday:</strong></p>
            </div>
            <div class="col-6">
              <p class="mb-1">9:00 AM - 5:00 PM</p>
              <p class="mb-1">Closed</p>
              <p class="mb-1">Closed</p>
            </div>
          </div>
          <div class="mt-3">
            <p class="mb-1 text-warning"><i class="bi bi-exclamation-triangle me-2"></i><strong>Emergency Care:</strong> Available 24/7</p>
          </div>
        </div>
      </div>

      <!-- Bottom Footer -->
      <div class="border-top border-secondary pt-4 mt-4">
        <div class="row align-items-center">
          <div class="col-md-6">
            <p class="mb-0">&copy; 2024 VetCare Veterinary Center. All rights reserved.</p>
          </div>
          <div class="col-md-6 text-md-end">
            <div class="d-flex justify-content-md-end gap-3">
              <a href="#" class="text-white text-decoration-none"><i class="bi bi-facebook"></i></a>
              <a href="#" class="text-white text-decoration-none"><i class="bi bi-twitter"></i></a>
              <a href="#" class="text-white text-decoration-none"><i class="bi bi-instagram"></i></a>
              <a href="#" class="text-white text-decoration-none"><i class="bi bi-linkedin"></i></a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap 5 JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Flatpickr JS -->
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  
  <!-- Enhanced Navbar JavaScript -->
  <script>
    // Navbar scroll effect
    window.addEventListener('scroll', function() {
      const navbar = document.querySelector('.navbar');
      if (window.scrollY > 50) {
        navbar.classList.add('scrolled');
      } else {
        navbar.classList.remove('scrolled');
      }
    });

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Add active class to current page nav item
    document.addEventListener('DOMContentLoaded', function() {
      const currentPage = window.location.pathname.split('/').pop() || 'index.html';
      const navLinks = document.querySelectorAll('.nav-link');
      
      navLinks.forEach(link => {
        const href = link.getAttribute('href');
        if (href === currentPage) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
    });

    // Enhanced dropdown animations
    const dropdowns = document.querySelectorAll('.dropdown');
    dropdowns.forEach(dropdown => {
      const menu = dropdown.querySelector('.dropdown-menu');
      const toggle = dropdown.querySelector('.dropdown-toggle');
      
      toggle.addEventListener('mouseenter', function() {
        menu.style.display = 'block';
        setTimeout(() => {
          menu.style.opacity = '1';
          menu.style.transform = 'translateY(0)';
        }, 10);
      });
      
      dropdown.addEventListener('mouseleave', function() {
        menu.style.opacity = '0';
        menu.style.transform = 'translateY(-10px)';
        setTimeout(() => {
          menu.style.display = 'none';
        }, 200);
      });
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      let datePickerInstance;
      let timePicker;
      let availableSlots = [];
      let bookedTimes = [];
      let selectedDate = '';

      // Function to fetch available slots for a selected date
      async function fetchAvailableSlots(selectedDate) {
        try {
          const response = await fetch(`http://127.0.0.1:8000/api/available-slots/?selected_date=${selectedDate}`);
          if (response.ok) {
            const data = await response.json();
            availableSlots = data.available_slots;
            bookedTimes = data.booked_times;
            
            // Update the time picker with available times
            updateTimePicker(data);
            
            // Show availability info to user
            updateAvailabilityInfo(data);
          } else {
            console.error('Failed to fetch available slots');
          }
        } catch (error) {
          console.error('Error fetching available slots:', error);
        }
      }

      // Function to fetch calendar availability for multiple days
      async function fetchCalendarAvailability() {
        try {
          const today = new Date().toISOString().split('T')[0];
          const response = await fetch(`http://127.0.0.1:8000/api/availability-calendar/?start_date=${today}`);
          if (response.ok) {
            const data = await response.json();
            updateCalendarInfo(data);
          } else {
            console.error('Failed to fetch calendar availability');
          }
        } catch (error) {
          console.error('Error fetching calendar availability:', error);
        }
      }

      // Function to update calendar information display
      function updateCalendarInfo(data) {
        const calendarInfo = document.getElementById('calendar-info');
        if (calendarInfo) {
          let calendarHtml = `
            <div class="alert alert-info mb-3">
              <h6 class="fw-bold mb-2"><i class="bi bi-calendar3 me-2"></i>Next 7 Days Availability</h6>
              <div class="row g-2">
          `;
          
          data.calendar.forEach(day => {
            let statusClass = 'text-muted';
            let statusIcon = 'bi-x-circle';
            
            if (day.status === 'high') {
              statusClass = 'text-success';
              statusIcon = 'bi-check-circle-fill';
            } else if (day.status === 'medium') {
              statusClass = 'text-warning';
              statusIcon = 'bi-clock-fill';
            } else if (day.status === 'low') {
              statusClass = 'text-danger';
              statusIcon = 'bi-exclamation-triangle-fill';
            } else if (day.status === 'closed') {
              statusClass = 'text-muted';
              statusIcon = 'bi-x-circle';
            }
            
            calendarHtml += `
              <div class="col-md-3 col-6">
                <div class="border rounded p-2 text-center ${day.is_available ? 'bg-light' : 'bg-light'}">
                  <div class="small fw-bold">${day.day_name}</div>
                  <div class="small text-muted">${day.date}</div>
                  <div class="${statusClass}">
                    <i class="bi ${statusIcon} me-1"></i>
                    ${day.is_available ? `${day.available_slots} slots` : 'Closed'}
                  </div>
                </div>
              </div>
            `;
          });
          
          calendarHtml += `
              </div>
              <small class="text-muted mt-2 d-block">
                <i class="bi bi-info-circle me-1"></i>
                ${data.note}
              </small>
            </div>
          `;
          
          calendarInfo.innerHTML = calendarHtml;
        }
      }

      // Function to update time picker with available times
      function updateTimePicker(data) {
        const timePicker = document.getElementById('timePicker');
        if (timePicker) {
          // Clear existing options
          timePicker.innerHTML = '';
          
          if (data.available_slots.length > 0) {
            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = 'Select a time';
            timePicker.appendChild(defaultOption);
            
            // Add available time slots
            data.available_slots.forEach(slot => {
              const timeOnly = slot.split(' ')[1]; // Extract time part (HH:MM)
              const displayTime = formatTimeForDisplay(timeOnly);
              
              const option = document.createElement('option');
              option.value = slot; // Full datetime for form submission
              option.textContent = displayTime;
              timePicker.appendChild(option);
            });
            
            timePicker.disabled = false;
          } else {
            // No available slots
            const noSlotsOption = document.createElement('option');
            noSlotsOption.value = '';
            noSlotsOption.textContent = 'No available times for this date';
            timePicker.appendChild(noSlotsOption);
            timePicker.disabled = true;
          }
        }
      }
      
      // Function to format time for display (12-hour format)
      function formatTimeForDisplay(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour % 12 || 12;
        return `${displayHour}:${minutes} ${ampm}`;
      }
      
      // Function to update availability information display
      function updateAvailabilityInfo(data) {
        const availabilityInfo = document.getElementById('availability-info');
        if (availabilityInfo) {
          const availableCount = data.available_slots.length;
          const totalSlots = 8; // 9 AM to 5 PM = 8 hours = 8 slots (1-hour intervals)
          const bookedCount = totalSlots - availableCount;
          const availabilityPercentage = (availableCount / totalSlots) * 100;
          
          let availabilityClass = 'availability-high';
          let availabilityIcon = 'bi-check-circle-fill';
          let availabilityText = 'High Availability';
          
          if (availabilityPercentage < 30) {
            availabilityClass = 'availability-low';
            availabilityIcon = 'bi-exclamation-triangle-fill';
            availabilityText = 'Limited Availability';
          } else if (availabilityPercentage < 70) {
            availabilityClass = 'availability-medium';
            availabilityIcon = 'bi-clock-fill';
            availabilityText = 'Moderate Availability';
          }
          
          availabilityInfo.innerHTML = `
            <div class="d-flex align-items-center gap-3 mt-2">
              <div class="availability-indicator ${availabilityClass}">
                <i class="bi ${availabilityIcon}"></i>
                <span>${availabilityText}</span>
              </div>
                              <div class="text-muted small">
                  <strong>${data.date}:</strong> ${availableCount} of ${totalSlots} slots available
                  ${availableCount > 0 ? `<br><small>Next available: ${data.available_slots[0]?.split(' ')[1] || 'N/A'}</small>` : ''}
                </div>
            </div>
          `;
        }
      }

      // Initialize date picker
      datePickerInstance = flatpickr("#datePicker", {
        dateFormat: "Y-m-d",
        minDate: "today", // Allow booking from today onwards
        disableMobile: true,
        allowInput: false,
        clickOpens: true,
        onChange: function(selectedDates, dateStr, instance) {
          if (selectedDates.length > 0) {
            selectedDate = selectedDates[0].toISOString().split('T')[0];
            fetchAvailableSlots(selectedDate);
          }
        }
      });

      // Fetch available slots for today on page load
      const today = new Date().toISOString().split('T')[0];
      selectedDate = today;
      fetchAvailableSlots(today);
      
      // Fetch calendar availability for next 7 days
      fetchCalendarAvailability();

      // Custom image upload functionality
      const imageInput = document.getElementById('image');
      const imageLabel = document.querySelector('.custom-image-label');
      const imageBtn = document.querySelector('.custom-image-btn');
      const imageFilename = document.getElementById('image-filename');
      const imagePreview = document.getElementById('image-preview');

      if (imageLabel && imageInput) {
        imageLabel.addEventListener('click', function(e) {
          if (e.target === imageBtn || e.target === imageLabel) {
            imageInput.click();
          }
        });
      }

      if (imageInput) {
        imageInput.addEventListener('change', function() {
          if (imageInput.files && imageInput.files[0]) {
            imageFilename.textContent = imageInput.files[0].name;
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
              imagePreview.style.display = 'block';
              imagePreview.innerHTML = `<img src="${e.target.result}" alt="Preview" style="max-width:120px; max-height:120px; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.10); margin-top:8px;">`;
            };
            reader.readAsDataURL(imageInput.files[0]);
          } else {
            imageFilename.textContent = 'No file chosen';
            imagePreview.style.display = 'none';
            imagePreview.innerHTML = '';
          }
        });
      }

      // Enhanced form submission with availability check
      const bookingForm = document.getElementById('bookingForm');
      if (bookingForm) {
        bookingForm.addEventListener('submit', async function(e) {
          e.preventDefault();
          
          const formData = new FormData(bookingForm);
          const selectedDate = formData.get('selected_date');
          const selectedTime = formData.get('selected_time');
          
          // Check if both date and time are selected
          if (!selectedDate || !selectedTime) {
            alert('Please select both a date and time for your appointment.');
            return;
          }
          
          // Check if selected time is available
          if (selectedTime && !availableSlots.includes(selectedTime)) {
            alert('Sorry, this time slot is no longer available. Please select another time.');
            return;
          }
          
          // Combine date and time for backend
          const combinedDateTime = selectedTime; // selectedTime already contains the full datetime
          
          // Update the form data with the combined datetime
          formData.set('appointment_date', combinedDateTime);
          formData.delete('selected_time'); // Remove the separate time field
          
          // Show loading state
          const submitBtn = bookingForm.querySelector('button[type="submit"]');
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Booking...';
          submitBtn.disabled = true;
          
          try {
            const response = await fetch('http://127.0.0.1:8000/api/book/', {
              method: 'POST',
              body: formData
            });
            
            if (response.ok) {
              const result = await response.json();
              
              // Show success message
              bookingForm.innerHTML = `
                <div class="success-message">
                  <i class="bi bi-check-circle-fill text-success" style="font-size: 3rem;"></i>
                                     <h3 class="mt-3">Booking Successful!</h3>
                   <p class="mb-2"><strong>Booking ID:</strong> ${result.booking_id}</p>
                   <p class="mb-2"><strong>Veterinarian:</strong> ${result.vet}</p>
                   <p class="mb-2"><strong>Service:</strong> ${result.service}</p>
                   <p class="mb-2"><strong>Pet Type:</strong> ${result.pet_type}</p>
                  <p class="mb-3">A confirmation email has been sent to your email address.</p>
                  <a href="index.html" class="btn btn-warning">Return to Home</a>
                </div>
              `;
              
              // Refresh available slots after successful booking
              fetchAvailableSlots(selectedDate);
              
            } else {
              const errorData = await response.json();
              alert(`Booking failed: ${errorData.detail}`);
            }
          } catch (error) {
            console.error('Error submitting booking:', error);
            alert('An error occurred while booking. Please try again.');
          } finally {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
          }
        });
      }
    });
  </script>
</body>
</html> 